import{k as V,b8 as Y,o as Z}from"./@illa-design-402f214a.js";import{r as n}from"./react-9b7e00e3.js";import{aI as ee,aJ as te,aK as se,aL as K,aE as ae}from"./index-2f1869ab.js";import{h as ne,I as re}from"./utils-c87ab5dc.js";import{T as ie}from"./index-5f69abbc.js";import{b as le}from"./style-7ce959a8.js";import{a as N}from"./@emotion-4f16718e.js";import"./codeMirror-vendor-eff8ab8d.js";import"./lodash-lib-6e94956b.js";import"./react-icons-vendor-2430ea65.js";const oe=N`
  display: flex;
  flex-direction: column;
`;N`
  width: 100%;
  display: flex;
  flex-direction: column;
  position: relative;
`;const ce=u=>u.map(o=>{if(!o)return;const{originFile:a,...d}=o;return d})||[],ue=(u,o)=>u.map((a,d)=>{var p,m,g,h,f;return{lastModified:(p=a.originFile)==null?void 0:p.lastModified,name:(m=a.originFile)==null?void 0:m.name,size:(g=a.originFile)==null?void 0:g.size,type:(h=a.originFile)==null?void 0:h.type,dataURI:`data:${((f=a.originFile)==null?void 0:f.type)??"text/plain"};base64,${o[d]}`,updateStatus:{status:a.status,percent:a.percent,response:a.response}}})||[],A=u=>{const{selectionType:o,type:a,showFileList:d,disabled:p,fileType:m=[],loading:g,buttonText:h,dropText:f,colorScheme:S,variant:F,fileList:x,onRemove:L,onChange:v,customRequest:U}=u,T=a==="dropzone",M=m.join(",");return V(Y,{customRequest:U,disabled:p,text:T?f:h,colorScheme:S,variant:F,loading:g,multiple:o==="multiple",directory:o==="directory",drag:T,...!!M&&{accept:M},...x&&{fileList:x},onRemove:L,onChange:v,showUploadList:d})};A.displayName="WrappedUpload";const de=u=>{const{displayName:o,appendFiles:a,customRule:d,tooltipText:p,required:m,minFiles:g,maxFiles:h,sizeType:f,maxSize:S,currentList:F,value:x,files:L,parseValue:v,minSize:U,validateMessage:T,triggerEventHandler:M,hideValidationMessage:E,updateComponentHeight:O,handleUpdateDsl:R,updateComponentRuntimeProps:P,deleteComponentRuntimeProps:W,handleUpdateMultiExecutionResult:$}=u,b=n.useRef([]),[k,C]=n.useState([]),I=n.useRef(0),c=n.useRef([]),j=n.useRef(k??[]),q=n.useRef(v??!1);n.useEffect(()=>{var e;if(F&&F.length>0&&x&&L&&((e=b.current)==null?void 0:e.length)===0&&c.current.length===0){const t=F.map((r,l)=>{const i=x[l],y=L[l];return{...r,originFile:i?ee(`data:${y.type};base64,${i}`,y.name):new File([""],y.name,y)}});C(t),b.current=t}},[F,x,L]);const z=n.useCallback((s,e)=>s.map(r=>r.uid||r.name).indexOf(e.uid||e.name),[]),w=n.useCallback(s=>{if(!E){const e=ne({value:s,minFiles:g,maxFiles:h,minSize:U,maxSize:S,sizeType:f,required:m,customRule:d});return e&&e.length>0?e:""}return""},[d,E,g,h,U,f,S,m]),H=n.useCallback(s=>{const e=w(s);return R({validateMessage:e}),e},[w,R]),D=n.useCallback(s=>{!s||j.current===s&&q.current===v||(j.current=s,q.current=v??!1,new Promise(async e=>{const t=await Promise.allSettled(s.map(async l=>await te(l)));let r;v&&(r=await Promise.allSettled(s.map(async l=>await se(l)))),e({values:t,parsedValues:r,fileList:s})}).then(e=>{const{values:t,parsedValues:r,fileList:l=[]}=e,i=w(l),y=K(t,"base64"),G=ue(l,y??[]),Q=K(r),X=ce(l);$([{displayName:o,value:{files:G,value:y,parsedValue:Q,validateMessage:i,currentList:X}}])}).then(()=>{M("change")}))},[o,w,$,v,M]),B=s=>{const e=c.current.length>0?[...c.current]:[...b.current||[]],t=z(e,s);return e.splice(t,1),C(e),b.current=e,c.current.length>0&&(c.current=e),D(e),!0},J=s=>{s.onSuccess()},_=n.useCallback((s,e)=>{let t=[...c.current];if(e.status==="init"){t.push(e),c.current=[...t],C(t),I.current+=1;return}const r=z(c.current,e);if(!(r<0)&&(t.splice(r,1,e),C(t),c.current=t,t.length===I.current&&I.current&&t.every(i=>i.status==="error"||i.status==="done"))){const i=a?[...b.current||[],...t]:t;C(i),b.current=i,c.current=[],I.current=0,D(i)}},[a,z,D]);return n.useEffect(()=>(P({clearValue:()=>{R({value:[]}),C([])},validate:()=>H(k),setDisabled:s=>{R({disabled:s})},clearValidation:()=>{R({validateMessage:""})}}),()=>{W()}),[k,W,R,H,P]),Z(ae,{updateComponentHeight:O,enable:!0,children:[V(ie,{tooltipText:p,tooltipDisabled:!p,children:V("div",{css:oe,children:V(A,{...u,fileList:k,onChange:_,onRemove:B,getValidateMessage:w,customRequest:J})})}),V("div",{css:le(0,"left",!0),children:V(re,{validateMessage:T})})]})};de.displayName="UploadWidget";export{de as UploadWidget,A as WrappedUpload,de as default};
//# sourceMappingURL=upload-897d7e81.js.map
