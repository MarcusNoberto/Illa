import{o as S,k as x,B as P,q as U}from"./@illa-design-1f43bb6c.js";import{r as t}from"./react-9b7e00e3.js";import{aN as B,aO as V,aP as j,aQ as I,aE as W}from"./index-4dce6ee8.js";import{h as C,I as N}from"./utils-1cfed9ac.js";import{T as H}from"./index-99007076.js";import{a as D,j as q}from"./@emotion-08a6282b.js";import{WrappedAudio as A}from"./audio-07e5bf0c.js";import"./codeMirror-vendor-320207e2.js";import"./lodash-lib-6e94956b.js";import"./react-icons-vendor-2430ea65.js";import"./index-207528bc.js";import"./index-a95bdaa9.js";const $=D`
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 15px;
  height: 100%;
  width: 100%;
`,z=D`
  width: 100%;
  height: 45px;
`,O=D`
  flex-direction: row;
  align-items: center;
  gap: 15px;
  height: 100%;
  width: 100%;
  box-sizing: border-box;
`,Q=D`
  &:hover,
  &:active {
    background-color: transparent !important;
  }
`,G=(a,e)=>{let m=Date.now(),f;const v=50;function l(){const w=m+e,i=Date.now()-w;i>v?m=Date.now()+i:m+=e,a(),f=setTimeout(l,Math.max(0,e-i))}return f=setTimeout(l,e),()=>{clearTimeout(f)}},M=a=>typeof a=="string"?a:"",J=a=>{const e=/^data:audio[^,]+base64,/;return typeof a!="string"||!a||!e.test(a)?"":a.replace(e,"")},K=(a,e)=>{const[m,f]=t.useState(!1),v=t.useRef(),[l,w]=t.useState(0),i=t.useRef(),d=t.useRef([]),n=t.useRef(null),c=t.useRef(null),[T,h]=t.useState(),g=t.useRef(),s=t.useRef(),R=t.useRef(),b=t.useCallback(async()=>{if(i.current&&i.current(),m&&n.current)n.current.stop(),a({recordTime:parseFloat(l.toFixed(1))}),f(!1);else try{n.current=null,c.current=await navigator.mediaDevices.getUserMedia({audio:!0});const o=new MediaRecorder(c.current);g.current=()=>{v.current=window.performance.now(),i.current=G(()=>{const y=(window.performance.now()-v.current)/1e3;w(y)},100)},s.current=p=>{d.current.push(p.data)},R.current=async()=>{c.current&&await c.current.getTracks().forEach(r=>r.stop());const p=new Blob(d.current,{type:o.mimeType}),y=URL.createObjectURL(p);h(y);var u=new FileReader;u.onload=function(r){var L;const E=(L=r.target)==null?void 0:L.result;E&&typeof E=="string"&&e&&e(E||"")},u.readAsDataURL(p),n.current&&(g.current&&n.current.removeEventListener("start",g.current),s.current&&n.current.removeEventListener("dataavailable",s.current),R.current&&n.current.removeEventListener("stop",R.current)),c.current=null,n.current=null},o.addEventListener("start",g.current),o.addEventListener("dataavailable",s.current),o.addEventListener("stop",R.current),o.start(),n.current=o,f(!0)}catch(o){console.log(o)}},[e,a,m,l]),k=()=>{d.current=[],T&&URL.revokeObjectURL(T),h(""),w(0),a({recordTime:0}),e&&e("")};return t.useEffect(()=>()=>{var o;i.current&&i.current(),n.current&&n.current.state!=="inactive"&&n.current.stop(),c.current&&((o=c.current.getTracks())==null||o.forEach(p=>p.stop()))},[c,n]),{isRecording:m,url:T,recordingTime:l,handleButtonClick:b,clearData:k}},X=a=>{const{value:e,loading:m=!1,disabled:f=!1,startText:v,stopText:l,clearText:w,colorScheme:i="blue",handleUpdateStatus:d,handleOnChange:n}=a,c=t.useRef(),[T,h]=t.useState(!0),{isRecording:g,url:s,recordingTime:R,handleButtonClick:b,clearData:k}=K(d,n),o=()=>{};return t.useEffect(()=>{var y;const p=u=>{const r=u.target;r.state==="granted"||r.state==="prompt"?(d({validateMessage:""}),h(!1)):r.state==="denied"&&(d({validateMessage:B}),h(!0))};return(y=navigator==null?void 0:navigator.permissions)==null||y.query({name:"microphone"}).then(u=>{c.current=u,u.state==="granted"||u.state==="prompt"?h(!1):u.state==="denied"&&(d({validateMessage:B}),h(!0)),u.addEventListener("change",p)}),()=>{var u;(u=c.current)==null||u.removeEventListener("change",p)}},[d]),t.useEffect(()=>{d({isRecording:g})},[d,g]),S("div",{css:O,children:[!s&&!e&&x(P,{onClick:b,disabled:T||f,loading:m,colorScheme:i,size:"large",w:"100%",children:g?`${M(l||j)} ${R.toFixed(1)}s`:M(v||V)}),(s||e)&&!g&&S("div",{css:$,children:[x(P,{onClick:k,loading:m,colorScheme:"grayBlue",variant:"text",css:Q,children:M(w||I)}),x("div",{css:z,children:q(A,{...a,key:s,url:s||e,controls:!0,onPlay:o,onPause:o,onEnded:o,onReady:o,onPlaybackRateChange:o})})]})]})},F=t.forwardRef((a,e)=>x("div",{ref:e,children:x(X,{...a})}));F.displayName="WrappedRecording";const Y=a=>{const{displayName:e,minDuration:m,maxDuration:f,required:v,value:l,isRecording:w,recordTime:i,tooltipText:d,customRule:n,hideValidationMessage:c,validateMessage:T,triggerEventHandler:h,updateComponentHeight:g,handleUpdateMultiExecutionResult:s,updateComponentRuntimeProps:R,deleteComponentRuntimeProps:b}=a,k=U(),o=t.useCallback(()=>{if(!c){let r;return l&&!i?r=C({value:l,customRule:n}):!l&&!i?r=C({value:void 0,required:v,customRule:n}):r=C({value:i,required:v,maxDuration:f??1e4,minDuration:m??0,customRule:n}),r&&r.length>0?r:""}return""},[n,c,f,m,i,v,l]),p=t.useCallback(()=>{const r=o();return s([{displayName:e,value:{validateMessage:r}}]),r},[e,o,s]),y=t.useCallback(r=>{new Promise(E=>{s([{displayName:e,value:{value:J(r),dataURI:r}}]),E(!0)}).then(()=>{h("change")})},[e,s,h]),u=t.useCallback(r=>{s([{displayName:e,value:r}])},[e,s]);return t.useEffect(()=>(R({clearValue:()=>{s([{displayName:e,value:{value:void 0}}])},validate:()=>p(),clearValidation:()=>{s([{displayName:e,value:{validateMessage:void 0}}])}}),()=>{b()}),[R,b,p,s,e,l,i,w,k]),S(W,{updateComponentHeight:g,children:[x(H,{tooltipText:d,tooltipDisabled:!d,children:x(F,{...a,handleOnChange:y,handleUpdateStatus:u,handleUpdateMultiExecutionResult:s})}),!c&&x("div",{children:x(N,{validateMessage:T})})]})};Y.displayName="RecordingWidget";export{Y as RecordingWidget,F as WrappedRecording,Y as default};
//# sourceMappingURL=recording-81d18bb0.js.map
